current request type org springframework security web servletapi securitycontextholderawarerequestwrapper spring test 
method controller wrote test method error fix h2 h2 remove argument controller works fine h2 h2 added code test class securitycontext xml 

problem controller request processed wrap original request href http docs spring io spring security site docs release reference htmlsingle ns custom filters rel nofollow spring security reference manual filter internal spring security setup run problem called test spring framework documentation register filter instances em setting mockmvc register filter instances em em registered filters invoked mockfilterchain spring test filter delegates dispatcherservlet em manually build configure order mimic filter declaration classic case work provided securitycontext xml build application context hr strong beware strong works adds complexity nice spring test framework simple url mapping tests tying spring security controller method spring machinery favor em separation concerns em controller method pratices suggest security lie elements form simple url rules method security service level complex cases track current user filter interceptor put relevant information request session attribute ordinary controller element spring msv extract tests simpler future evolutions change security layer current case falling trap test ul li declare principal request li li spring security filter pass filters wraps request securitycontext populated principal wrapped request null li ul principal initial request populate securitycontextholder setup security filter chain authentication manager test profile alternatively create scratch custom filter ul li principal request li li null clear securitycontextholder li li ul li build authentication object advise testingauthenticationtoken li li build securitycontext populates authentication object li li populates securitycontextholder securitycontext li ul li li wraps original request securitycontextholderawarerequestwrapper li li pass wrapped request filter chain li ul configuring mockmvc complex adds class dedicated test tested principal wrapped request authentication object wrapped request returns security context tying spring security controller method bad idea code custom filter 