erratic stampedlock unlock long behaviour 
facing strange behaviour href https docs oracle javase docs api util concurrent locks stampedlock html stampedlock main problematic lines code strange behaviour unlock tolerates wrong read stamp correct hr reference full code output pre class lang prettyprint override 

strong short answer strong adding stamp modifying portion require validation read mode locks strong long answer strong stamp pieces information state sequence number readers state number stored bits stamp reader count stored bits add stamp changing reader count leaving state number unchanged stampedlock acquired read mode state number validated reader count makes sense read locks unlock order read stamp acquired existing stampedlock state number reader count read stamp acquired stampedlock state number reader count state numbers stamps stampedlocks state changed acquisition stamps read stamp unlock state number stamp matches state number stampedlock fine reader count stamp match reader count stampedlock doesnt matter read locks unlock order unlock succeeds href http www ndcmagazine stampedlock rel nofollow stampedlocks designed high performing read write locks internal utilities withstand malicious coding operating intended boundaries javadoc href https docs oracle javase docs api util concurrent locks stampedlock html unlock long rel nofollow unlock misleading 